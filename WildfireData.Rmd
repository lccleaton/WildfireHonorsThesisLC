---
title: "Wildfire Data"
author: "Laina Cleaton"
date: "2025-10-26"
output: html_document
---

```{r setup_tidyverse, eval=FALSE}
library(tidyverse)
```

```{r read_files, eval = FALSE}
evac_zone_status <- read_csv("evac_zone_status_geo_event_map.csv")
evac_zones <- read_csv("evac_zones_gis_evaczone.csv")
geo_events <- read_csv("geo_events_geoevent.csv")
```

```{r evac_zone_status, eval = FALSE}
view(evac_zone_status)
```

```{r evac_zones, eval = FALSE}
view(evac_zones)
```

```{r geo_events, eval = FALSE}
view(geo_events)
```

In order to conduct a temporal and spatial analysis, we will join the **evac_zone_status**, **geo_events**, and **evac_zones** datasets. The 'changelog' datasets are unnecessary for the analysis.

The first join, **evac_zone_status** and **geo_events** (by geo_event_id), is important because **evac_zone_status** does not include information on the wildfire (name, geographical location, etc.). **evac_zone_status** only tracks the evacuation zone's activity over time, so by joining these two tables, we will be able to see the evacuation status changes associated with a specific wildfire.

The second join, **evac_zone_status** and **evac_zones** (by uid_v2), brings in the spatial component. Each evacuation zone's geometry and display name will be attached to its status updates, which means we'll be able to pinpoint the when and where each evacuation occurred. Evacuation boundaries can be visualized, their areas calculated, and they can be overlayed with demographic data.

Altogether, the "core spatial dataset" brings together the components of the who, when, and where of wildfire evacuations; which fire the evacuations were associated with, when they were created, and where they occurred.

```{r install_sf, eval = FALSE}
install.packages("sf")
```

```{r wildfire_joins, eval = FALSE}

library(sf)

# --- Convert CSVs to sf objects using WKT column ---
# evac_zones
evac_zones <- st_as_sf(evac_zones, wkt = "geom", crs = 4326)

# select evac_zone_status columns
evac_zone_status_sel <- evac_zone_status %>%
  rename(status_date = date_created) %>%
  select(uid_v2, geo_event_id, status_date)

# select geo_events columns
geo_events_sel <- geo_events %>%
  rename(geo_event_id = id) %>%
  select(geo_event_id, name, lat, lng)

# select evac_zones columns
evac_zones_sel <- evac_zones %>%
  rename(geom_evac_zone = geom) %>%
  select(uid_v2, display_name, geom_evac_zone)

#join columns
core_wildfire_dataset <- evac_zone_status_sel %>%
  left_join(geo_events_sel, by = "geo_event_id") %>%
  left_join(evac_zones_sel, by = "uid_v2") %>%
  st_as_sf()

```

We cannot use rows with NA in **display_name** because they lack geometry, and could break spatial joins. Therefore, we can filter these NA's out.

```{r filter_core_wildfire_dataset, eval = FALSE}
core_wildfire_geo <- core_wildfire_dataset %>%
  filter(!is.na(display_name))

```

After joining the selected WatchDuty tables into a single dataset, each record now represents a single evacuation status update. This means that there can be multiple entries per evacuation zone, **uid_v2**, as its status changes over time. Thus we will need to summarize those updates into meaningful evacuation timelines:

```         
1. Evacuation start time: the earliest status_date recorded for that zone. 
2. Evacuation end time: the latest status_date recorded.
3. Evacuation duration: the time difference between those two points.
```

This step outputs one row per evacuation zone per fire. Thus we can describe how long communities were under evacuation and visualize the temporal progression of the evacuations.

```{r evac_timeline, eval = FALSE}
evac_timeline <- core_wildfire_geo %>%
  st_drop_geometry() %>%      
  group_by(uid_v2) %>%
  summarise(
    n_updates = n(),
    min_date = min(status_date),
    max_date = max(status_date),
    diff_hours = as.numeric(difftime(max_date, min_date, units = "hours"))
  ) %>%
  arrange(desc(diff_hours))

```

Next, we can visualize the joined dataset, using leaflet.


```{r install_leaflet, eval = FALSE}
install.packages("leaflet")
```


```{r leaflet_joins_visualization, eval = FALSE}
library(leaflet)

leaflet(filter(core_wildfire_geo, name %in% top_fires)) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    fillColor = ~factor(name),
    color = "#444",
    weight = 1,
    popup = ~paste("<b>Fire:</b>", name, "<br><b>Zone:</b>", display_name)
  )
```

This shows that the fires from WatchDuty are from Minnesota (near Duluth, on the western tip of Lake Superior) and California. I will be focusing on California for my research. 

```{r california_filter, eval = FALSE}
cali_wildfire <- core_wildfire_geo %>%
  mutate(geom_evac_zone = st_make_valid(geom_evac_zone))

ca_bbox <- st_sfc(
  st_polygon(list(rbind(
    c(-125, 32),  # SW corner
    c(-125, 42),  # NW corner
    c(-114, 42),  # NE corner
    c(-114, 32),  # SE corner
    c(-125, 32)   # Close the polygon
  ))),
  crs = st_crs(cali_wildfire)  # match CRS
)
```




Now that we have all of our data, we can overlay it with demographic and economic data.
